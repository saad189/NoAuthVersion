<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>License Verification</title>
    <link rel="stylesheet" href="styles/license.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Styles for the language selector */
      .language-selector {
        position: relative;
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        width: 100%;
      }
      .language-selector-inner {
        display: flex;
        align-items: center;
        background: rgba(0, 0, 0, 0.6);
        padding: 5px 12px;
        border-radius: 20px;
        box-shadow: 0 0 10px rgba(0, 150, 255, 0.7);
        backdrop-filter: blur(3px);
        border: 1px solid rgba(0, 150, 255, 0.5);
      }
      .language-selector select {
        background: rgba(0, 0, 0, 0.3);
        color: white;
        border: 1px solid rgba(0, 150, 255, 0.5);
        border-radius: 15px;
        padding: 3px 10px;
        font-family: "Rajdhani", sans-serif;
        outline: none;
        box-shadow: inset 0 0 5px rgba(0, 150, 255, 0.3);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 110px;
      }
      .language-selector select:hover {
        border-color: rgba(0, 200, 255, 0.8);
        box-shadow: 0 0 8px rgba(0, 200, 255, 0.8),
          inset 0 0 5px rgba(0, 150, 255, 0.3);
      }
      .language-selector select:focus {
        border-color: rgba(0, 255, 255, 1);
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.8),
          inset 0 0 5px rgba(0, 150, 255, 0.3);
      }
      .language-selector label {
        margin-right: 10px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        font-family: "Rajdhani", sans-serif;
        font-weight: 500;
        text-shadow: 0 0 5px rgba(0, 150, 255, 0.7);
        white-space: nowrap;
        letter-spacing: 1px;
      }
    </style>
  </head>
  <body>
    <!-- Effect particles -->
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>

    <!-- Main cursor -->
    <div class="cursor-dot" id="cursor-dot"></div>

    <!-- Trail container -->
    <div class="cursor-trail-container" id="cursor-trail-container"></div>

    <div class="container">
      <!-- Moved inside container and before header -->
      <div class="language-selector">
        <div class="language-selector-inner hologram-effect">
          <label for="language-select" data-i18n="language.select"
            >Language:</label
          >
          <select id="language-select">
            <option value="en" selected>English</option>
            <option value="fr">Fran√ßais</option>
            <option value="es">Espa√±ol</option>
            <option value="de">Deutsch</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="pt">Portugu√™s</option>
            <option value="it">Italiano</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="zh">‰∏≠Êñá</option>
            <option value="ko">ÌïúÍµ≠Ïñ¥</option>
          </select>
        </div>
      </div>

      <div class="header hologram-effect">
        <h1 data-text="License Verification" data-i18n="app.title">
          License Verification
        </h1>
      </div>

      <div class="card hologram-effect" id="license-form">
        <div
          id="saved-license-notification"
          class="saved-license-notification"
          style="display: none"
        >
          <p>
            <span data-i18n="license.savedLicense"
              >A license is already saved:</span
            >
            <span id="saved-license-display"></span>
          </p>
          <div
            class="action-buttons"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <button
              id="useSavedBtn"
              class="btn btn-block"
              data-i18n="license.useThis"
            >
              Use this license
            </button>
            <button
              id="enterNewBtn"
              class="btn btn-block btn-secondary"
              data-i18n="license.enterNew"
            >
              Enter a new license
            </button>
          </div>
        </div>

        <div id="license-input-form">
          <div class="form-group">
            <label for="licenseKey" data-i18n="license.key">License Key</label>
            <input
              type="text"
              id="licenseKey"
              class="form-control"
              data-i18n-placeholder="license.keyPlaceholder"
              placeholder="Enter your license key"
            />
          </div>
          <button
            id="validateBtn"
            class="btn btn-block"
            data-i18n="license.validate"
          >
            Validate License
          </button>
        </div>

        <div
          class="buy-license-section"
          style="
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
          "
        >
          <p
            style="text-align: center; margin-bottom: 10px"
            data-i18n="license.notYetLicense"
          >
            Don't have a license yet?
          </p>
          <button
            id="buyLicenseBtn"
            class="btn btn-block btn-secondary"
            data-i18n="license.buy"
          >
            Buy a License
          </button>
        </div>
      </div>

      <div
        id="checking-result"
        class="result hologram-effect"
        style="display: none"
      >
        <div class="spinner"></div>
        <p data-i18n="license.checking">Checking your license...</p>
      </div>

      <div
        id="valid-result"
        class="result valid hologram-effect"
        style="display: none"
      >
        <div class="result-icon">‚úì</div>
        <h2 data-i18n="license.valid">Valid License</h2>
        <p data-i18n="license.validSuccess">
          Your license has been validated successfully.
        </p>

        <div class="license-info">
          <div class="license-key-display">
            <p>
              <strong data-i18n="license.key">License key:</strong>
              <span id="license-key-display"></span>
            </p>
          </div>
          <div id="expiration-info"></div>
        </div>

        <div class="license-question">
          <h3 data-i18n="license.useQuestion">Use this license?</h3>
          <div class="action-buttons">
            <button
              id="useYesBtn"
              class="btn btn-success"
              data-i18n="license.yes"
            >
              Yes
            </button>
            <button id="useNoBtn" class="btn btn-danger" data-i18n="license.no">
              No
            </button>
          </div>
        </div>

        <div id="update-section" style="margin-top: 15px">
          <div style="display: flex; gap: 10px; width: 100%">
            <button
              id="checkUpdatesBtn"
              class="btn flex-equal"
              style="width: 50%"
              data-i18n="updates.check"
            >
              Check for updates
            </button>
            <button
              id="viewChangelogBtn"
              class="btn btn-secondary flex-equal"
              style="width: 50%; margin-top: 0"
              data-i18n="updates.changelog"
            >
              Version history
            </button>
          </div>

          <div
            id="update-info"
            class="update-info"
            style="display: none; margin-top: 10px"
          >
            <div class="update-info-title">
              <i id="update-icon">üîÑ</i>
              <span id="update-title" data-i18n="updates.checking"
                >Checking for updates...</span
              >
            </div>
            <p id="update-message"></p>
            <div id="update-action" class="update-action" style="display: none">
              <button
                id="downloadUpdateBtn"
                class="btn btn-secondary"
                data-i18n="updates.download"
              >
                Download update
              </button>
            </div>
          </div>

          <div
            id="changelog-info"
            class="update-info"
            style="display: none; margin-top: 10px"
          >
            <div class="update-info-title">
              <i id="changelog-icon">üìã</i>
              <span id="changelog-title" data-i18n="updates.changelog"
                >Version history</span
              >
            </div>
            <div id="changelog-content" class="changelog-content"></div>
          </div>
        </div>
      </div>

      <div
        id="invalid-result"
        class="result invalid hologram-effect"
        style="display: none"
      >
        <div class="result-icon">‚úó</div>
        <h2 data-i18n="license.invalid">Invalid License</h2>
        <p id="invalid-message" data-i18n="license.invalidDefault">
          Unable to validate your license.
        </p>
        <button
          id="retryBtn"
          class="btn"
          style="margin-top: 15px"
          data-i18n="license.retry"
        >
          Retry
        </button>

        <div
          class="buy-license-section"
          style="
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 0, 0, 0.3);
          "
        >
          <p
            style="text-align: center; margin-bottom: 10px"
            data-i18n="license.needValid"
          >
            Need a valid license?
          </p>
          <button
            id="buyLicenseBtnInvalid"
            class="btn btn-block btn-secondary"
            data-i18n="license.buy"
          >
            Buy a License
          </button>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>
        &copy; 2025 6Truc.
        <span data-i18n="app.allRights">All rights reserved.</span>
      </p>
    </div>

    <script src="licenseRenderer.js"></script>

    <!-- Script for language switching -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Cache to store loaded translations
        const translationsCache = {};

        /**
         * Load a translation file
         * @param {string} language - Language code to load
         * @returns {Promise<Object>} - Promise resolved with translations
         */
        async function loadTranslations(language) {
          // If already cached, return directly
          if (translationsCache[language]) {
            return translationsCache[language];
          }

          try {
            // Load JSON file
            const response = await fetch(`../translations/${language}.json`);

            // Ensure response is OK
            if (!response.ok) {
              console.error(
                `[i18n] Error loading translations for ${language}: ${response.status} ${response.statusText}`
              );
              return null;
            }

            // Parse JSON
            const translations = await response.json();

            // Cache it
            translationsCache[language] = translations;

            console.log(`[i18n] Translations loaded for language: ${language}`);
            return translations;
          } catch (error) {
            console.error(
              `[i18n] Error loading translations for ${language}:`,
              error
            );
            return null;
          }
        }

        /**
         * Get a translation by key
         * @param {string} key - Translation key (format: namespace.key or key)
         * @param {Object} translations - Translations object
         * @returns {string} - Translated text or key if not found
         */
        function getTranslation(key, translations) {
          if (!translations) return key;

          // Split the key into parts (e.g., "app.title" -> ["app", "title"])
          const parts = key.split(".");
          let result = translations;

          // Traverse parts to get the value
          for (const part of parts) {
            if (result && result[part] !== undefined) {
              result = result[part];
            } else {
              // Key not found: return the key itself
              console.warn(`[i18n] Translation key not found: ${key}`);
              return key;
            }
          }

          return result;
        }

        /**
         * Update UI with translations
         * @param {Object} translations - Translations object
         */
        function updateUI(translations) {
          if (!translations) return;

          // Inject translations in a hidden div for licenseRenderer.js
          let translationsDiv = document.getElementById("translations-data");
          if (!translationsDiv) {
            translationsDiv = document.createElement("div");
            translationsDiv.id = "translations-data";
            translationsDiv.style.display = "none";
            document.body.appendChild(translationsDiv);
          }
          translationsDiv.textContent = JSON.stringify(translations);

          // Update all elements with data-i18n attribute
          document.querySelectorAll("[data-i18n]").forEach((element) => {
            const key = element.getAttribute("data-i18n");
            const translation = getTranslation(key, translations);

            if (translation) {
              // If it's a data-text element (hologram effect)
              if (element.hasAttribute("data-text")) {
                element.setAttribute("data-text", translation);
              }

              // Update content
              element.textContent = translation;
            }
          });

          // Update all placeholders
          document
            .querySelectorAll("[data-i18n-placeholder]")
            .forEach((element) => {
              const key = element.getAttribute("data-i18n-placeholder");
              const translation = getTranslation(key, translations);

              if (translation && element.hasAttribute("placeholder")) {
                element.setAttribute("placeholder", translation);
              }
            });

          // Update page title
          const titleTranslation = getTranslation("app.title", translations);
          if (titleTranslation) {
            document.title = titleTranslation;
          }
        }

        /**
         * Change the interface language
         * @param {string} language - Language code
         */
        async function changeLanguage(language) {
          const translations = await loadTranslations(language);
          if (translations) {
            updateUI(translations);
            localStorage.setItem("app-language-preference", language);
            console.log(`[i18n] Language changed to: ${language}`);

            // Dispatch a custom event to notify scripts with dynamic content
            const languageChangeEvent = new CustomEvent("languageChanged", {
              detail: { language, translations },
            });
            document.dispatchEvent(languageChangeEvent);

            // Propagate language change to backend services
            try {
              await window.licenseAPI.changeLanguage(language);
              console.log(
                `[i18n] Language propagated to services: ${language}`
              );
            } catch (error) {
              console.error(
                `[i18n] Error while propagating language: ${error}`
              );
            }
          } else {
            console.error(`[i18n] Unable to change language to: ${language}`);
          }
        }

        const languageSelect = document.getElementById("language-select");

        // Load preferred language from localStorage
        const savedLanguage =
          localStorage.getItem("app-language-preference") || "en";
        languageSelect.value = savedLanguage;

        // Apply language on load
        changeLanguage(savedLanguage);

        // Save language choice and update the interface
        languageSelect.addEventListener("change", function () {
          const selectedLanguage = this.value;
          changeLanguage(selectedLanguage);
        });
      });
    </script>

    <!-- Script for the cursor trail effect -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Remove existing trail container
        const trailContainer = document.getElementById(
          "cursor-trail-container"
        );
        if (trailContainer) {
          trailContainer.remove();
        }

        // Reference to the main cursor dot
        const cursorDot = document.getElementById("cursor-dot");

        // Hide native cursor
        document.body.style.cursor = "none";

        // Array to store trail particles
        const trailElements = [];
        const MAX_TRAIL_PARTICLES = 15; // Limiter le nombre de particules

        // Enable custom cursor on interactive elements
        const interactiveElements = document.querySelectorAll(
          "button, input, a, select"
        );
        interactiveElements.forEach((element) => {
          element.addEventListener("mouseenter", () => {
            cursorDot.style.width = "20px";
            cursorDot.style.height = "20px";
            cursorDot.style.opacity = "0.9";
            cursorDot.style.border = "2px solid white";
            cursorDot.style.background = "rgba(0, 0, 255, 0.7)";
          });

          element.addEventListener("mouseleave", () => {
            cursorDot.style.width = "10px";
            cursorDot.style.height = "10px";
            cursorDot.style.opacity = "1";
            cursorDot.style.border = "none";
            cursorDot.style.background = "rgba(255, 0, 0, 1)";
          });
        });

        // Update main cursor position
        document.addEventListener("mousemove", function (e) {
          const mouseX = e.clientX;
          const mouseY = e.clientY;

          // Apply position using clientX/clientY (relative to the visible window)
          cursorDot.style.left = `${mouseX}px`;
          cursorDot.style.top = `${mouseY}px`;

          // Create a trail particle
          createTrailElement(mouseX, mouseY);
        });

        // Create a fading trail element
        function createTrailElement(x, y) {
          // Limit the number of particles
          if (trailElements.length >= MAX_TRAIL_PARTICLES) {
            // Remove the oldest particle
            const oldestTrail = trailElements.shift();
            if (oldestTrail && oldestTrail.parentNode) {
              oldestTrail.parentNode.removeChild(oldestTrail);
            }
          }

          // Create a new div for the trail
          const trail = document.createElement("div");
          trail.classList.add("trail-particle");

          // Apply initial styles
          trail.style.position = "fixed"; // fixed instead of absolute to follow the viewport
          trail.style.width = "8px";
          trail.style.height = "8px";
          trail.style.borderRadius = "50%";
          trail.style.background =
            "radial-gradient(circle, rgba(255, 0, 0, 1) 0%, rgba(255, 0, 0, 0.6) 40%, transparent 90%)";
          trail.style.boxShadow = "0 0 5px #ff0000";
          trail.style.left = `${x}px`;
          trail.style.top = `${y}px`;
          trail.style.transform = "translate(-50%, -50%)";
          trail.style.pointerEvents = "none";
          trail.style.zIndex = "9999";
          trail.style.mixBlendMode = "screen";
          trail.style.opacity = "0.8";

          // Append element to body
          document.body.appendChild(trail);

          // Add to particles array
          trailElements.push(trail);

          // Opacity animation to fade out the element
          let opacity = 0.8;
          let size = 8;

          const fadeOut = setInterval(() => {
            opacity -= 0.05;
            size += 0.25;

            if (trail && trail.style) {
              trail.style.opacity = opacity;
              trail.style.width = `${size}px`;
              trail.style.height = `${size}px`;
              trail.style.filter = `blur(${(1 - opacity) * 3}px)`;

              if (opacity <= 0) {
                clearInterval(fadeOut);
                if (trail.parentNode) {
                  trail.parentNode.removeChild(trail);
                }
                // Remove from the array
                const index = trailElements.indexOf(trail);
                if (index > -1) {
                  trailElements.splice(index, 1);
                }
              }
            } else {
              clearInterval(fadeOut);
            }
          }, 25);
        }

        // Handle the case when the cursor leaves the window
        document.addEventListener("mouseout", function (e) {
          if (e.relatedTarget === null) {
            cursorDot.style.opacity = "0";
          }
        });

        document.addEventListener("mouseover", function (e) {
          cursorDot.style.opacity = "1";
        });

        // Clean up trail particles on scroll to avoid overload
        let scrollTimeout;
        window.addEventListener("scroll", function () {
          // Temporarily hide particles while scrolling
          trailElements.forEach((trail) => {
            if (trail && trail.style) {
              trail.style.opacity = "0";
            }
          });

          // Clear existing timeout
          clearTimeout(scrollTimeout);

          // Set a new timeout
          scrollTimeout = setTimeout(function () {
            // Remove all old particles after scrolling
            trailElements.forEach((trail) => {
              if (trail && trail.parentNode) {
                trail.parentNode.removeChild(trail);
              }
            });
            // Empty the array
            trailElements.length = 0;
          }, 100);
        });
      });
    </script>
  </body>
</html>
